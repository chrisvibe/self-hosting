services:
  cloudflared:
    image: cloudflare/cloudflared:2024.11.1
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - web

  certbot:
    image: certbot/dns-cloudflare:v5.1.0
    container_name: certbot
    volumes:
      - ./certbot/config:/etc/letsencrypt
      - ./certbot/work:/var/lib/letsencrypt
      - ./certbot/logs:/var/log/letsencrypt
      - ./certbot/cloudflare.ini:/cloudflare.ini:ro
      - ./certbot/ssl:/nginx-ssl
    environment:
      - DOMAIN=${DOMAIN}
    entrypoint: /bin/sh
    command: -c "trap exit TERM; while :; do certbot certonly --dns-cloudflare --dns-cloudflare-credentials /cloudflare.ini --email admin@${DOMAIN} --agree-tos --non-interactive -d ${DOMAIN} -d '*.${DOMAIN}' --deploy-hook 'cp /etc/letsencrypt/live/${DOMAIN}/fullchain.pem /nginx-ssl/cert.pem && cp /etc/letsencrypt/live/${DOMAIN}/privkey.pem /nginx-ssl/key.pem && chmod 644 /nginx-ssl/cert.pem && chmod 600 /nginx-ssl/key.pem'; sleep 12h; done"
    networks:
      - web

  proxy:
    image: nginx:1.29-alpine
    container_name: lan-proxy
    restart: unless-stopped
    ports:
      - "${LOCAL_IP}:80:80"
      - "${LOCAL_IP}:443:443"
    volumes:
      - ./nginx/conf.d/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/ssl:/etc/nginx/ssl:ro
    networks:
      - web
    depends_on:
      - cloudflared
      - certbot

  gotify:
    image: gotify/server:2.7.3
    container_name: gotify
    volumes:
      - gotify_data:/app/data
    restart: unless-stopped
    networks:
      - web

  wud:
    image: getwud/wud:latest
    container_name: wud
    environment:
      # CRITICAL: Disable all automatic actions
      - WUD_TRIGGER=false

      # Gotify notifications
      - WUD_TRIGGER_GOTIFY_GOTIFY_URL=http://gotify:80
      - WUD_TRIGGER_GOTIFY_GOTIFY_TOKEN=${GOTIFY_TOKEN}

      # Only watch containers with wud.watch=true label
      - WUD_WATCHER_DOCKER_WATCHBYDEFAULT=false

      # Check every 12 hours (adjust as needed)
      - WUD_WATCHER_DOCKER_CRON=0 */12 * * *

      # Info level logging
      - WUD_LOG_LEVEL=info
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    networks:
      - web

volumes:
  gotify_data:

networks:
  web:
    external: true
    name: web
