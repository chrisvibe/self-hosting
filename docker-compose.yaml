services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - web

  certbot:
    image: certbot/dns-cloudflare:latest
    container_name: certbot
    volumes:
      - ./certbot/config:/etc/letsencrypt
      - ./certbot/work:/var/lib/letsencrypt
      - ./certbot/logs:/var/log/letsencrypt
      - ./certbot/cloudflare.ini:/cloudflare.ini:ro
      - ./certbot/ssl:/nginx-ssl
    environment:
      - DOMAIN=${DOMAIN}
    entrypoint: /bin/sh
    command: -c "trap exit TERM; while :; do certbot certonly --dns-cloudflare --dns-cloudflare-credentials /cloudflare.ini --email admin@${DOMAIN} --agree-tos --non-interactive -d ${DOMAIN} -d '*.${DOMAIN}' --deploy-hook 'cp /etc/letsencrypt/live/${DOMAIN}/fullchain.pem /nginx-ssl/cert.pem && cp /etc/letsencrypt/live/${DOMAIN}/privkey.pem /nginx-ssl/key.pem && chmod 644 /nginx-ssl/cert.pem && chmod 600 /nginx-ssl/key.pem'; sleep 12h; done"
    networks:
      - web

  proxy:
    image: nginx:alpine
    container_name: lan-proxy
    restart: unless-stopped
    ports:
      - "${LOCAL_IP}:80:80"
      - "${LOCAL_IP}:443:443"
    volumes:
      - ./nginx/conf.d/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/ssl:/etc/nginx/ssl:ro
    networks:
      - web
    depends_on:
      - cloudflared
      - certbot

networks:
  web:
    external: true
    name: web
