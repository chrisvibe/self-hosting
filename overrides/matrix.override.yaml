# Matrix service override for self-hosting infrastructure
# This file connects Matrix nginx to the shared tunnel network
# Port exposure removed - LAN proxy handles routing

services:
  nginx:
    container_name: matrix-nginx
    labels:
      - 'wud.watch=true'
      - 'wud.tag.include=^\d+(\.\d+)*-alpine$'     # Only numeric-alpine tags
      - 'wud.tag.exclude=.*(rc|alpha|beta).*$'     # Exclude tags with non-numeric suffixes


    ports: !override
      # Remove HTTP port - proxy handles it
      # Keep federation port exposed directly (needs SSL)
      - "${LOCAL_IP}:8448:8448"
    networks:
      - net        # Internal Matrix network (from base compose)
      - web        # External tunnel network (shared)

  synapse:
    labels:
      - 'wud.watch=true'
      - 'wud.tag.include=^v\d+(\.\d+)*$'      # Only numeric versions, v1.2.3, v1.143.0
      - 'wud.tag.exclude=.*(rc|alpha|beta).*$' # Exclude any tags containing rc, alpha, beta

  db:
    labels:
      - 'wud.watch=true'
      - 'wud.tag.include=^\d+(\.\d+)*-alpine$'     # Only numeric-alpine tags
      - 'wud.tag.exclude=.*(rc|alpha|beta).*$'     # Exclude tags with non-numeric suffixes

  element:
    labels:
      - 'wud.watch=true'
      - 'wud.tag.include=^v\d+(\.\d+)*$'      # Only numeric versions, v1.2.3, v1.143.0
      - 'wud.tag.exclude=.*(rc|alpha|beta).*$' # Exclude any tags containing rc, alpha, beta


networks:
  web:
    external: true
    name: web
  net:
    # References the 'net' network from matrix docker-compose.yaml
